<!DOCTYPE html>
<html lang="en-US">

  <head>
    <meta charset='utf-8'>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,maximum-scale=2">
    <link rel="stylesheet" type="text/css" media="screen" href="/assets/css/style.css?v=fe772bc21305bb5daa0261831cbce08a6127ca74">

<!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Files Authorization &amp; Analytics API | IBM Aspera Analytics API</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Files Authorization &amp; Analytics API" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Use Aspera IBM’s Analytics API to view Aspera on Cloud (“AoC”) application activity, transfer status and metadata, file access and volume usage." />
<meta property="og:description" content="Use Aspera IBM’s Analytics API to view Aspera on Cloud (“AoC”) application activity, transfer status and metadata, file access and volume usage." />
<link rel="canonical" href="http://localhost:4000/analytics-api.html" />
<meta property="og:url" content="http://localhost:4000/analytics-api.html" />
<meta property="og:site_name" content="IBM Aspera Analytics API" />
<script type="application/ld+json">
{"description":"Use Aspera IBM’s Analytics API to view Aspera on Cloud (“AoC”) application activity, transfer status and metadata, file access and volume usage.","@type":"WebPage","url":"http://localhost:4000/analytics-api.html","headline":"Files Authorization &amp; Analytics API","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  </head>

  <body>
    <!-- HEADER -->
    <div id="header_wrap" class="outer top-container">
        <header class="inner">
          <h1 id="project_title">IBM Aspera Analytics API</h1>
          <!-- <h2 id="project_tagline">Use Aspera IBM's Analytics API to view Aspera on Cloud ("AoC") application activity, transfer status and metadata, file access and volume usage.</h2> -->
          <p><a class="project-link"href="http://github.com/LauraKirby/aspera-ibm-analytics-api">View on GitHub</a> </p>
          
        </header>
    </div>
    <nav class="sticky">
      <a href="/">Home</a>
      <a href="./setup.html">Setup</a>
      <a href="./analytics-api.html">API Requests</a>
    </nav>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer content">
      <section id="main_content" class="inner">
        <h1 id="files-authorization--analytics-api">Files Authorization &amp; Analytics API</h1>

<ol>
  <li>
    <p>Terminal</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> touch get_analytics_data.rb Gemfile
</code></pre></div>    </div>
  </li>
  <li>
    <p>Copy and paste the following into <code class="highlighter-rouge">./Gemfile</code></p>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

 <span class="n">gem</span> <span class="s1">'jwt'</span>
 <span class="n">gem</span> <span class="s1">'rest-client'</span>
 <span class="n">gem</span> <span class="s1">'byebug'</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Install Gems, from terminal</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c"># from project root directory</span>
 bundle
</code></pre></div>    </div>
  </li>
  <li>
    <p>Add hard-coded data and helper methods</p>

    <ul>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># load secrets from config file</span>
 <span class="c1"># this file should be added to your .gitignore,</span>
 <span class="c1"># it has been added here for purpose of demonstation</span>
 <span class="n">yaml</span> <span class="o">=</span> <span class="no">YAML</span><span class="p">.</span><span class="nf">load_file</span><span class="p">(</span><span class="s1">'config.yml'</span><span class="p">)</span>

  <span class="c1"># helper methods</span>
 <span class="k">def</span> <span class="nf">base64url_encode</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
   <span class="no">Base64</span><span class="p">.</span><span class="nf">encode64</span><span class="p">(</span><span class="n">str</span><span class="p">).</span><span class="nf">tr</span><span class="p">(</span><span class="s1">'+/'</span><span class="p">,</span> <span class="s1">'-_'</span><span class="p">).</span><span class="nf">gsub</span><span class="p">(</span><span class="sr">/[\n=]/</span><span class="p">,</span> <span class="s1">''</span><span class="p">)</span>
 <span class="k">end</span>

 <span class="k">def</span> <span class="nf">pretty_print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
   <span class="n">pretty</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">pretty_generate</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
   <span class="nb">puts</span> <span class="n">pretty</span>
 <span class="k">end</span>

 <span class="c1"># Load information about the Files instance being used</span>
 <span class="n">private_key</span> <span class="o">=</span> <span class="no">OpenSSL</span><span class="o">::</span><span class="no">PKey</span><span class="o">::</span><span class="no">RSA</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'jwtRS256.key'</span><span class="p">))</span>
 <span class="n">scope</span> <span class="o">=</span> <span class="s1">'admin%3Aall'</span>
 <span class="n">environment</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'environment'</span><span class="p">]</span>
 <span class="n">organization_name</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'organization_name'</span><span class="p">]</span>
 <span class="n">organization_id</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'organization_id'</span><span class="p">]</span>
 <span class="n">client_id</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'client_id'</span><span class="p">]</span>
 <span class="n">client_secret</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'client_secret'</span><span class="p">]</span>
 <span class="n">email</span> <span class="o">=</span> <span class="n">yaml</span><span class="p">[</span><span class="s1">'useremail'</span><span class="p">]</span>

 <span class="n">time</span> <span class="o">=</span> <span class="no">Time</span><span class="p">.</span><span class="nf">now</span><span class="p">.</span><span class="nf">to_i</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Generate JWT: Specify values for the follow JWT header keys</p>

    <ul>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># specify authentication type and hashing algorithm</span>
 <span class="n">request_header</span> <span class="o">=</span> <span class="p">{</span>
   <span class="ss">typ: </span><span class="s1">'JWT'</span><span class="p">,</span>
   <span class="ss">alg: </span><span class="s1">'RS256'</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Generate JWT: Specify values for the follow JWT body keys</p>

    <ul>
      <li>issuer (‘iss’): the client ID that is generated when you register an API client.</li>
      <li>subject (‘sub’): the email address of the user who will use the bearer token for authentication.</li>
      <li>audience (‘aud’): is always the <a href="https://api.asperafiles.com/api/v1/oauth2/token">Files API endpoint</a>.</li>
      <li>not before (‘nbf’): a Unix timestamp when the bearer token becomes valid</li>
      <li>
        <p>expiration (‘exp’): a Unix timestamp when the bearer token expires</p>
      </li>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="n">request_body</span> <span class="o">=</span> <span class="p">{</span>
   <span class="ss">iss: </span><span class="n">client_id</span><span class="p">,</span>
   <span class="ss">sub: </span><span class="n">email</span><span class="p">,</span>
   <span class="ss">aud: </span><span class="s1">'https://api.asperafiles.com/api/v1/oauth2/token'</span><span class="p">,</span>
   <span class="ss">nbf: </span><span class="n">time</span> <span class="o">-</span> <span class="mi">3600</span><span class="p">,</span>
   <span class="ss">exp: </span><span class="n">time</span> <span class="o">+</span> <span class="mi">3600</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Generate JWT: Construction</p>

    <ul>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># construct the hashed JWT</span>
 <span class="n">payload</span> <span class="o">=</span> <span class="n">base64url_encode</span><span class="p">(</span><span class="n">request_header</span><span class="p">.</span><span class="nf">to_json</span><span class="p">)</span> <span class="o">+</span> <span class="s1">'.'</span> <span class="o">+</span> <span class="n">base64url_encode</span><span class="p">(</span><span class="n">request_body</span><span class="p">.</span><span class="nf">to_json</span><span class="p">)</span>
 <span class="n">signed</span> <span class="o">=</span> <span class="n">private_key</span><span class="p">.</span><span class="nf">sign</span><span class="p">(</span><span class="no">OpenSSL</span><span class="o">::</span><span class="no">Digest</span><span class="o">::</span><span class="no">SHA256</span><span class="p">.</span><span class="nf">new</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span>
 <span class="n">jwt_token</span> <span class="o">=</span> <span class="n">payload</span> <span class="o">+</span> <span class="s1">'.'</span> <span class="o">+</span> <span class="n">base64url_encode</span><span class="p">(</span><span class="n">signed</span><span class="p">)</span>

 <span class="c1"># #{environment + '.' } should be removed below when using production environments</span>
 <span class="n">files_url</span> <span class="o">=</span> <span class="s2">"https://api.</span><span class="si">#{</span><span class="n">environment</span> <span class="o">+</span> <span class="s1">'.'</span> <span class="si">}</span><span class="s2">ibmaspera.com/api/v1/oauth2/</span><span class="si">#{</span><span class="n">org</span><span class="si">}</span><span class="s2">/token"</span>
 <span class="n">parameters</span> <span class="o">=</span> <span class="s2">"assertion=</span><span class="si">#{</span><span class="n">jwt_token</span><span class="si">}</span><span class="s2">&amp;grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&amp;scope=</span><span class="si">#{</span><span class="n">scope</span><span class="si">}</span><span class="s2">"</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Setup Files request object</p>

    <ul>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># setup Files request object</span>
 <span class="n">client</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">::</span><span class="no">Resource</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
   <span class="n">files_url</span><span class="p">,</span>
   <span class="ss">user: </span><span class="n">client_id</span><span class="p">,</span>
   <span class="ss">password: </span><span class="n">client_secret</span><span class="p">,</span>
   <span class="ss">headers: </span><span class="p">{</span> <span class="ss">content_type: </span><span class="s1">'application/x-www-form-urlencoded'</span> <span class="p">}</span>
 <span class="p">)</span>

 <span class="c1"># make request to Files API</span>
 <span class="n">result</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="nf">post</span><span class="p">(</span><span class="n">parameters</span><span class="p">),</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
 <span class="n">pretty_print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Extract ‘bearer token’ from Files response and make Analytics API request</p>

    <ul>
      <li>add the following to the bottom of <code class="highlighter-rouge">./get_analytics_data.rb</code></li>
    </ul>

    <div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1"># extract 'bearer token'</span>
 <span class="n">bearer_token</span> <span class="o">=</span> <span class="s2">"Bearer </span><span class="si">#{</span><span class="n">result</span><span class="p">[</span><span class="ss">:access_token</span><span class="p">]</span><span class="si">}</span><span class="s2">"</span>

 <span class="nb">puts</span> <span class="s2">"</span><span class="se">\n\n</span><span class="s2">bearer_token: </span><span class="si">#{</span><span class="n">bearer_token</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">"</span>

 <span class="c1"># setup Analytics request object</span>
 <span class="n">get_analytics</span> <span class="o">=</span> <span class="no">RestClient</span><span class="o">::</span><span class="no">Resource</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
   <span class="s2">"https://api.qa.ibmaspera.com/analytics/v2/organizations/</span><span class="si">#{</span><span class="n">org_id</span><span class="si">}</span><span class="s2">/volume_usage"</span><span class="p">,</span>
   <span class="ss">headers: </span><span class="p">{</span> <span class="no">Authorization</span><span class="p">:</span> <span class="n">bearer_token</span> <span class="p">}</span>
 <span class="p">)</span>

 <span class="c1"># make request to Analytics API</span>
 <span class="n">result</span> <span class="o">=</span> <span class="no">JSON</span><span class="p">.</span><span class="nf">parse</span><span class="p">(</span><span class="n">get_analytics</span><span class="p">.</span><span class="nf">get</span><span class="p">,</span> <span class="ss">symbolize_names: </span><span class="kp">true</span><span class="p">)</span>
 <span class="n">pretty_print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Run script in terminal</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code> ruby get_analytics_data.rb
</code></pre></div>    </div>

    <ul>
      <li>You should see the tokens printed in terminal as well as the Analytics API response.</li>
    </ul>
  </li>
</ol>

<h2 id="additional-resources">Additional resources</h2>

<ul>
  <li><a href="https://developer.asperasoft.com/web/files/jwt-authorization">Files JWT Authorization</a></li>
  <li><a href="https://tools.ietf.org/html/rfc7519">Learn more about JWT</a></li>
  <li><a href="https://developer.ibm.com/aspera/docs/aspera-api-tutorials-use-cases/building-file-sending-application-files-api/">Files API Example</a></li>
</ul>

      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        
        <p class="copyright">IBM Aspera Analytics API is maintained by <a href="http://github.com/LauraKirby">LauraKirby</a></p>
        
      </footer>
    </div>

    
  </body>
</html>
